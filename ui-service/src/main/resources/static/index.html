<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Tic Tac Toe</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); grid-gap: 5px; margin-top: 20px; }
        .cell { width: 100px; height: 100px; background-color: #fff; border: 2px solid #333; display: flex; justify-content: center; align-items: center; font-size: 2em; font-weight: bold; }
        .controls { margin-top: 20px; }
        button { padding: 10px 20px; font-size: 1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:disabled { background-color: #ccc; }
        .status { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
        .history { margin-top: 20px; width: 310px; height: 150px; overflow-y: auto; border: 1px solid #ccc; background: white; padding: 10px; }
        .log-entry { border-bottom: 1px solid #eee; padding: 2px 0; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>Tic Tac Toe Simulation</h1>
    <div class="controls">
        <button id="startBtn">Start Simulation</button>
    </div>
    <div class="status" id="status">Status: Idle</div>
    <div class="board" id="board">
        <div class="cell" id="cell-0-0">-</div>
        <div class="cell" id="cell-0-1">-</div>
        <div class="cell" id="cell-0-2">-</div>
        <div class="cell" id="cell-1-0">-</div>
        <div class="cell" id="cell-1-1">-</div>
        <div class="cell" id="cell-1-2">-</div>
        <div class="cell" id="cell-2-0">-</div>
        <div class="cell" id="cell-2-1">-</div>
        <div class="cell" id="cell-2-2">-</div>
    </div>
    <div class="history" id="history">
        <div>Move History:</div>
    </div>

    <script>
        let sessionId = null;
        let gameId = null;
        let pollingInterval = null;

        const startBtn = document.getElementById('startBtn');
        const statusDiv = document.getElementById('status');
        const historyDiv = document.getElementById('history');

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            statusDiv.innerText = 'Status: Initializing...';
            statusDiv.style.color = 'black';
            historyDiv.innerHTML = '<div>Move History:</div>';
            clearBoard();

            try {
                const sessionRes = await fetch('/api/sessions', { method: 'POST' });
                if (!sessionRes.ok) {
                    const errorData = await sessionRes.json();
                    throw new Error(errorData.message || 'Failed to create session');
                }
                const session = await sessionRes.json();
                sessionId = session.sessionId;
                gameId = session.gameId;

                statusDiv.innerText = 'Status: Starting simulation...';
                const simulateRes = await fetch(`/api/sessions/${sessionId}/simulate`, { method: 'POST' });
                if (!simulateRes.ok) {
                    const errorData = await simulateRes.json();
                    throw new Error(errorData.message || 'Failed to start simulation');
                }

                startPolling();
            } catch (err) {
                console.error(err);
                statusDiv.innerText = 'Status: Error - ' + err.message;
                statusDiv.style.color = 'red';
                startBtn.disabled = false;
            }
        });

        function clearBoard() {
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    document.getElementById(`cell-${r}-${c}`).innerText = '-';
                }
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(updateGameState, 1000);
        }

        async function updateGameState() {
            try {
                // Poll session for status and history
                const sessionRes = await fetch(`/api/sessions/${sessionId}`);
                if (!sessionRes.ok) {
                    const errorData = await sessionRes.json();
                    throw new Error(errorData.message || 'Failed to poll session');
                }
                const session = await sessionRes.json();

                statusDiv.innerText = `Status: ${session.lastStatus}`;
                
                // Update history
                historyDiv.innerHTML = '<div>Move History:</div>';
                session.moveHistory.forEach(move => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerText = move;
                    historyDiv.appendChild(div);
                });

                // Poll engine for board
                const gameRes = await fetch(`/api/games/${gameId}`);
                if (gameRes.ok) {
                    const game = await gameRes.json();
                    updateBoard(game.board);
                }

                if (session.lastStatus !== 'IN_PROGRESS') {
                    clearInterval(pollingInterval);
                    startBtn.disabled = false;
                }
            } catch (err) {
                console.error('Polling error:', err);
                statusDiv.innerText = 'Status: Polling Error - ' + err.message;
                statusDiv.style.color = 'red';
                clearInterval(pollingInterval);
                startBtn.disabled = false;
            }
        }

        function updateBoard(board) {
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    document.getElementById(`cell-${r}-${c}`).innerText = board[r][c];
                }
            }
        }
    </script>
</body>
</html>
